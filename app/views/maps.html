{% extends "layout.html" %}

{% block page_title %}Graphs - FIS Prototype - GOV.UK{% endblock %}

{% block head %}
  {% include "partials/head.html" %}
  {% include "partials/snippets_head.html" %}
  <!--<link rel="stylesheet" href="https://openlayers.org/en/v3.19.1/css/ol.css" type="text/css">-->
  <link rel="stylesheet" href="/public/stylesheets/vendor/ol.css" type="text/css">
  <script src="https://openlayers.org/en/v3.19.1/build/ol.js" type="text/javascript"></script>
{% endblock %}

{% block content %}

<main id="content" role="main" tabindex="-1">

	{% include "partials/phase_banner.html" %}
	{% include "partials/breadcrumb.html" %}

	<div class="grid-row">

		<div class="column-two-thirds">

			<h1 class="heading-xlarge">
				<span class="heading-secondary">FIS Prototype</span>
				Maps
			</h1>

		</div>

	</div>

	<div class="grid-row">

		<div class="column-two-thirds">

			<section aria-labelledby="flood-warning-area" role="region">

				<h2 id="flood-warning-area" class="heading-medium">
					Warning or severe warning
				</h2>       

				<div class="map" id="map"></div>

			</section>

		</div>

	</div>

</main>

{% endblock %}

{% block body_end %}
  <!-- GOV.UK elements redirect -->
  <!--<script src="/public/javascripts/redirect.js"></script>-->
  {% include "partials/scripts.html" %}

  <!-- Open layers -->
  <!-- Below is for visual and interaction reference only -->
  <!-- Will need to be converted to production code -->

	<script type="text/javascript">

		const selectedId = '123FWF315'; // Warning
		//const selectedId = '123WAF963'; // Alert
		//const selectedId = '123FWF308'; // Warning removed

		const opacity = 0.75;


		var geoJSON = '/public/javascripts/json/features.json';
		
		var tile = new ol.layer.Tile({
			source: new ol.source.OSM()
		});

		var tileSelected = new ol.layer.Tile({
			source: new ol.source.OSM()
		});

		var styleFunction = function(feature, resolution, alpha = 1) {

			// Alert area colours
			var strokeColour = '#f18700';
			var fillColour = 'rgba(241,135,0,' + alpha + ')';
			var strokeWidth = 1;
			var zIndex = 2;

			// Warning or severe warning colours
			if (feature.get('severity') == 1 || feature.get('severity') == 2) {
				strokeColour = '#e3000f';
				fillColour = 'rgba(227,0,15,' + alpha + ')';
				zIndex = 3;
			}
			
			// Warning removed colours
			else if (feature.get('severity') == -1) {
				strokeColour = '#6f777b';
				fillColour = 'rgba(111,119,123,' + alpha + ')';
				zIndex = 3;				
			}

			// Generate style
			var style = new ol.style.Style({
				fill: new ol.style.Fill({ color: fillColour }),			
				stroke: new ol.style.Stroke({ color: strokeColour, width: strokeWidth, miterLimit: 2, lineJoin: 'round' }),
				zIndex: zIndex 
			});

			return style;

		};

		var source = new ol.source.Vector({
			format: new ol.format.GeoJSON(),
			url: geoJSON,
			defaultProjection :'EPSG:4326', 
			projection: 'EPSG:3857'
		});

		var targetAreas = new ol.layer.Image({
			source: new ol.source.ImageVector({
				source: source,

				// Use custom style function to colour feature accordingley
				style: styleFunction

			}),
			opacity: opacity
		});

		var view = new ol.View({
			center: ol.proj.fromLonLat([-1.98221629139491,53.7296721399487]),
			zoom: 14
		});

		// Render map

		var map = new ol.Map({
			target: 'map',
			layers: [tile, targetAreas, tileSelected],
			view: view
		});

		// Draw the selected feature on top of the image layer

		tileSelected.on('precompose', function(e){

			// Save initial clipping state of canvas
			e.context.save();

			// Set feature to selected feature from geojson 
			feature = source.getFeatureById(selectedId);

			// Draw the selected border/glow first
			e.vectorContext.drawFeature(feature, new ol.style.Style({
				stroke: new ol.style.Stroke({ color: '#ffbf47', width: 10, miterLimit: 2, lineJoin: 'round' })
			}));

			// Set this polygon as a clipping mask for this layers tile content
			e.context.clip();
		});

		tileSelected.on('postcompose', function(e) {

			// Restore the canvas so no subsequent content is clipped/masked
			e.context.restore();

			// Draw the feature again using the style function to apply corrct colour and apply opacity
			e.vectorContext.drawFeature(feature, styleFunction(feature, view.getResolution(), opacity));

		});

		// Change pointer type and highlight style

		map.on('pointermove', function (e) {
			var pixel = map.getEventPixel(e.originalEvent);
			var hit = map.hasFeatureAtPixel(pixel);
			map.getViewport().style.cursor = hit ? 'pointer' : '';
		});


	</script>

	<!-- / Visual and interaction reference -->
	<!-- / Open layers -->
{% endblock %}